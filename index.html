<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Fitoscents</title>
        
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
        
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
        <link rel="stylesheet" href="assets/css/main.css">
        
    </head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 shadow">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">游녬 Fitoscents</a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
    
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <div class="navbar-nav gap-2">
                    <a href="index.html" class="nav-link active">Inicio</a>
                    <a href="products.html" class="nav-link ">游닍 Inventario</a>
                    <a href="ventas.html" class="nav-link">游눯 Ventas</a>
                    <a href="clientes.html" class="nav-link">游논 Clientes</a>
                </div>
            </div>
        </div>
    </nav>

<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h2 class="fw-bold text-dark">Resumen del Negocio</h2>
            <p class="text-muted">Estado actual de tu inversi칩n y ganancias.</p>
        </div>
    </div>

    <div class="row g-4 mb-5">
        
        <div class="col-md-6 col-lg-3">
            <div class="card card-kpi bg-primary shadow h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title mb-0">CAPITAL INVERTIDO</h6>
                        <i class="bi bi-box-seam icon-box"></i>
                    </div>
                    <h3 class="fw-bold mb-0 kpi-value" id="kpi-stock-costo">$0.00</h3>
                    <small class="opacity-75">Dinero parado en botellas</small>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card card-kpi text-white bg-success shadow h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title mb-0">VENTA POTENCIAL</h6>
                        <i class="bi bi-graph-up-arrow icon-box"></i>
                    </div>
                    <h3 class="fw-bold mb-0" id="kpi-stock-venta">$0.00</h3>
                    <small class="opacity-75">Si vendes todo hoy</small>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card card-kpi text-white bg-warning shadow h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title mb-0">GANANCIA TOTAL</h6>
                        <i class="bi bi-cash-stack icon-box"></i>
                    </div>
                    <h3 class="fw-bold mb-0" id="kpi-ganancia-total">$0.00</h3>
                    <small class="opacity-75">Utilidad Neta (T칰 + Socio)</small>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card card-kpi bg-white text-dark shadow h-100 border-start border-5 border-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title mb-0 text-muted">BOTELLAS EN STOCK</h6>
                        <i class="bi bi-upc-scan icon-box text-info"></i>
                    </div>
                    <h3 class="fw-bold mb-0" id="kpi-cantidad-stock">0</h3>
                    <small class="text-muted">Unidades f칤sicas</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-dark fw-bold py-3">
                    游끥 Top Perfumes (M치s Stock)
                </div>
                <ul class="list-group list-group-flush" id="list-top-stock" >
                    </ul>
                <div class="card-footer bg-dark text-center">
                    <a href="products.html" class="btn btn-sm btn-outline-primary">Ir a Inventario Completo</a>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-dark fw-bold py-3">
                    游 Acciones R치pidas
                </div>
                <div class="card-body d-grid gap-3">
                    <a href="products.html" class="btn btn-outline-success btn-lg text-start">
                        <i class="bi bi-plus-circle me-2"></i> Registrar Nueva Compra
                    </a>
                    <a href="ventas.html" class="btn btn-outline-info btn-lg text-start">
                        <i class="bi bi-wallet2 me-2"></i> Ver Deudas y Pagos
                    </a>
                    <button onclick="descargarRespaldoGlobal()" class="btn btn-secondary text-start">
                        <i class="bi bi-cloud-arrow-down me-2"></i> Respaldar Todo Ahora
                    </button>
                    <a href="clientes.html" class="btn btn-outline-danger btn-lg text-start">
                        <i class="bi bi-people me-2"></i> Cobrar a Clientes
                    </a>

                    <button onclick="exportarExcel()" class="btn btn-success text-start">
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i> Descargar Excel
                    </button>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="assets/js/config.js"></script>    <script src="assets/js/utils.js"></script>     <script src="assets/js/inventory.js"></script> <script src="assets/js/sales.js"></script>     <script src="assets/js/cart.js"></script>      <script src="assets/js/backup.js"></script>    <script src="assets/js/main.js"></script>      ```
<script>
    // --- L칍GICA DEL DASHBOARD ---
    //const DB_KEY = 'perfume_inventory_v1';
    //const SALES_KEY = 'perfume_sales_v1';

    document.addEventListener('DOMContentLoaded', () => {
        calcularKPIs();
    });

    function calcularKPIs() {
        // 1. Obtener Datos
        const productos = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        const ventas = JSON.parse(localStorage.getItem(SALES_KEY)) || [];

        // --- C츼LCULOS DE INVENTARIO ---
        
        // Sumar Costo Total (Capital invertido)
        const totalCostoStock = productos.reduce((sum, prod) => sum + (parseFloat(prod.costo) || 0), 0);
        
        // Sumar Venta Potencial (Si vendieras todo hoy)
        const totalVentaStock = productos.reduce((sum, prod) => sum + (parseFloat(prod.precioVenta) || 0), 0);
        
        // Cantidad de Botellas
        const cantidadBotellas = productos.length;

        // --- C츼LCULOS DE VENTAS ---
        
        // Ganancia Neta Hist칩rica (Suma de todas las utilidades)
        const totalUtilidad = ventas.reduce((sum, venta) => sum + (parseFloat(venta.utilidad) || 0), 0);

        // --- PINTAR EN PANTALLA ---
        document.getElementById('kpi-stock-costo').innerText = formatMoney(totalCostoStock);
        document.getElementById('kpi-stock-venta').innerText = formatMoney(totalVentaStock);
        document.getElementById('kpi-ganancia-total').innerText = formatMoney(totalUtilidad);
        document.getElementById('kpi-cantidad-stock').innerText = cantidadBotellas;

        // --- GENERAR LISTA TOP (Los 5 perfumes m치s caros que tienes en stock) ---
        const listaTop = document.getElementById('list-top-stock');
        listaTop.innerHTML = '';
        
        // Ordenar productos por precio de venta (Mayor a menor) y tomar los 5 primeros
        const topProductos = [...productos].sort((a, b) => b.precioVenta - a.precioVenta).slice(0, 5);

        if (topProductos.length === 0) {
            listaTop.innerHTML = '<li class="list-group-item text-muted text-center">Sin inventario</li>';
        } else {
            topProductos.forEach(prod => {
                listaTop.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${prod.nombre}</strong>
                            <div class="small text-muted">${prod.marca}</div>
                        </div>
                        <span class="badge bg-light text-dark border">$${prod.precioVenta}</span>
                    </li>
                `;
            });
        }
    }

    // Funci칩n auxiliar para respaldo r치pido desde el Dashboard
    function descargarRespaldoGlobal() {
    // Capturamos TODAS las bases de datos
    const backupData = {
        inventory: JSON.parse(localStorage.getItem(DB_KEY) || '[]'),
        sales: JSON.parse(localStorage.getItem(SALES_KEY) || '[]'),
        payouts: JSON.parse(localStorage.getItem('perfume_payouts_v1') || '[]'), // Aseg칰rate de usar la misma key que en clientes.html
        timestamp: new Date().toISOString()
    };

    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `RESPALDO_COMPLETO_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

    function formatMoney(amount) {
        return '$' + amount.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    // --- AGREGAR ESTO AQU칈 EN INDEX.HTML PARA QUE FUNCIONE EL BOT칍N ---
    function exportarExcel() {
        // Leemos la base de datos directo del navegador
        const productos = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        
        if (productos.length === 0) return alert("Nada que exportar.");

        // 1. Crear encabezados CSV
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "SKU,Producto,Marca,Costo,Precio Venta,Inversion,Destino,ImagenURL\n";

        // 2. Recorrer datos
        productos.forEach(p => {
            const nombreLimpio = p.nombre.replace(/,/g, " "); // Evitar errores con comas
            // Agregamos la imagen al final
            const fila = `${p.sku},${nombreLimpio},${p.marca},${p.costo},${p.precioVenta},${p.inversion},${p.destino},${p.imagen || ''}`;
            csvContent += fila + "\n";
        });

        // 3. Descargar archivo
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        const fecha = new Date().toISOString().slice(0,10);
        link.setAttribute("download", `Inventario_Excel_${fecha}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
</body>
</html>