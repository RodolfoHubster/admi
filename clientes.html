<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Fitoscents Admin</title>
        
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
        
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
        <link rel="stylesheet" href="assets/css/main.css">
        <script src="components/header.js"></script>
    </head>
<body>



    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-dark">GestiÃ³n de Clientes</h2>
                <p class="text-muted">Cobranza y seguimiento de pedidos.</p>
            </div>
            <button class="btn btn-dark" onclick="alert('PrÃ³ximamente: Lista de Interesados/Leads')">
                <i class="bi bi-notebook"></i> Anotar Interesado
            </button>
        </div>
    
        <ul class="nav nav-tabs mb-4" id="clientesTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active fw-bold text-dark" id="deudas-tab" data-bs-toggle="tab" data-bs-target="#deudas-content" type="button">
                    ðŸ’° Cuentas por Cobrar (<span id="count-deudores">0</span>)
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link fw-bold text-dark" id="pedidos-tab" data-bs-toggle="tab" data-bs-target="#pedidos-content" type="button">
                    ðŸ“¦ Pedidos y Encargos (<span id="count-pedidos">0</span>)
                </button>
            </li>
        </ul>
    
        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="deudas-content" role="tabpanel">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card bg-dark text-white text-center p-3">
                            <h6 class="text-secondary">TOTAL EN LA CALLE</h6>
                            <h2 class="text-gold fw-bold mb-0" id="total-calle">$0.00</h2>
                        </div>
                    </div>
                </div>
                <div class="table-responsive shadow-sm rounded">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Cliente</th>
                                <th>Productos Debidos</th>
                                <th>Saldo Pendiente</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clientes-table-body" class="bg-white">
                            </tbody>
                    </table>
                </div>
            </div>
    
            <div class="tab-pane fade" id="pedidos-content" role="tabpanel">
                <div class="alert alert-info border-0 shadow-sm text-dark">
                    <i class="bi bi-info-circle-fill me-2"></i> 
                    Estos son perfumes registrados en el <strong>Inventario</strong> asignados a un cliente. 
                    Si cambias la ubicaciÃ³n a "En Inventario", aparecerÃ¡n como listos.
                </div>
                <div class="table-responsive shadow-sm rounded">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-secondary text-white">
                            <tr>
                                <th>Cliente</th>
                                <th>Perfume Encargado</th>
                                <th>Estado Actual</th> <th>InversiÃ³n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="encargos-table-body" class="bg-white">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<div class="modal fade" id="modalAbonar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">ðŸ’¸ Recibir Abono</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-secondary">
                    Cliente: <strong id="abonar-cliente">---</strong><br>
                    Deuda Actual: <strong class="text-danger" id="abonar-deuda">---</strong>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Monto a Abonar ($)</label>
                    <input type="number" class="form-control form-control-lg" id="inputAbono" placeholder="Ej: 200">
                </div>
                
                <input type="hidden" id="abonar-id-venta">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="confirmarAbono()">âœ… Registrar Pago</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/config.js"></script>
<script src="assets/js/utils.js"></script>
<script>
    // Referencias a Datos
    const ventas = JSON.parse(localStorage.getItem(SALES_KEY)) || [];
    const inventario = JSON.parse(localStorage.getItem(DB_KEY)) || []; // LEEMOS INVENTARIO TAMBIÃ‰N

    document.addEventListener('DOMContentLoaded', () => {
        renderDeudas();
        renderEncargos();
    });

    // --- 1. LÃ“GICA DE DEUDAS (TAB 1) ---
    function renderDeudas() {
    const ventas = JSON.parse(localStorage.getItem(SALES_KEY)) || [];
    const clientesMap = {};
    let totalCalle = 0;

    // Agrupar
    ventas.forEach(v => {
        if (v.saldoPendiente > 0 && v.cliente) {
            if (!clientesMap[v.cliente]) {
                clientesMap[v.cliente] = { 
                    nombre: v.cliente, 
                    deudaActual: 0, 
                    totalOriginal: 0, // Nuevo: CuÃ¡nto era la venta original total
                    items: [] 
                };
            }
            clientesMap[v.cliente].deudaActual += parseFloat(v.saldoPendiente);
            // Calculamos cuÃ¡nto costaba el producto originalmente para sacar el porcentaje
            clientesMap[v.cliente].totalOriginal += parseFloat(v.precioFinal);
            clientesMap[v.cliente].items.push(v.producto);
            totalCalle += parseFloat(v.saldoPendiente);
        }
    });

    document.getElementById('total-calle').innerText = formatMoney(totalCalle);
    document.getElementById('count-deudores').innerText = Object.keys(clientesMap).length;

    const tbody = document.getElementById('clientes-table-body');
    tbody.innerHTML = '';

    Object.values(clientesMap).forEach(c => {
        // CÃ¡lculos para la barra
        const pagado = c.totalOriginal - c.deudaActual;
        const porcentajePagado = (pagado / c.totalOriginal) * 100;
        
        // Color de la barra segÃºn progreso
        let colorBarra = 'bg-danger';
        if(porcentajePagado > 50) colorBarra = 'bg-warning';
        if(porcentajePagado > 80) colorBarra = 'bg-success';

        tbody.innerHTML += `
            <tr>
                <td class="fw-bold">${c.nombre}</td>
                <td style="width: 30%;">
                    <div class="d-flex justify-content-between small mb-1">
                        <span>Progreso de Pago</span>
                        <span class="fw-bold">${Math.round(porcentajePagado)}%</span>
                    </div>
                    <div class="progress" style="height: 10px; background-color: #333;">
                        <div class="progress-bar ${colorBarra}" role="progressbar" style="width: ${porcentajePagado}%"></div>
                    </div>
                    <small class="text-muted">${c.items.length} perfumes</small>
                </td>
                <td class="text-danger fw-bold fs-5">$${c.deudaActual.toFixed(2)}</td>
                <td>
                    <a href="ventas.html?cliente=${c.nombre}" class="btn btn-sm btn-outline-light">
                        <i class="bi bi-wallet2"></i> Ver Detalles
                    </a>
                </td>
            </tr>
        `;
    });

    if (Object.keys(clientesMap).length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-muted">ðŸŽ‰ Nadie te debe dinero hoy.</td></tr>`;
    }
}
    // --- 2. LÃ“GICA DE ENCARGOS (TAB 2) ---
    function renderEncargos() {
        const tbody = document.getElementById('encargos-table-body');
        tbody.innerHTML = '';
        let contadorEncargos = 0;

        // Filtramos inventario donde haya un cliente asignado
        const encargos = inventario.filter(prod => prod.cliente && prod.cliente.trim() !== '');

        // Ordenamos: Primero los que YA LLEGARON ("en_inventario")
        encargos.sort((a, b) => (a.ubicacion === 'en_inventario' ? -1 : 1));

        encargos.forEach(prod => {
            contadorEncargos++;
            
            // LÃ³gica de Estado Inteligente
            let estadoBadge = '';
            let accionBtn = '';

            if (prod.ubicacion === 'en_inventario' || prod.ubicacion === 'stock') {
                // YA LLEGÃ“
                estadoBadge = `<span class="badge bg-success shadow-sm p-2"><i class="bi bi-check-circle-fill"></i> LISTO PARA ENTREGA</span>`;
                // El botÃ³n lleva a procesar la venta directamente
                accionBtn = `<button class="btn btn-sm btn-success" onclick="venderEncargo(${prod.id})">Entregar y Cobrar</button>`;
            } else {
                // VIENE EN CAMINO
                estadoBadge = `<span class="badge bg-warning text-dark p-2"><i class="bi bi-truck"></i> EN TRANSITO</span>`;
                accionBtn = `<small class="text-muted">Esperando llegada...</small>`;
            }

            tbody.innerHTML += `
                <tr>
                    <td class="fw-bold text-primary">${prod.cliente}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="${prod.imagen}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%; margin-right: 10px;">
                            <div>
                                <strong>${prod.nombre}</strong><br>
                                <small>${prod.marca}</small>
                            </div>
                        </div>
                    </td>
                    <td>${estadoBadge}</td>
                    <td><small>${prod.inversion.toUpperCase()}</small></td>
                    <td>${accionBtn}</td>
                </tr>
            `;
        });

        document.getElementById('count-pedidos').innerText = contadorEncargos;

        if (contadorEncargos === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted">ðŸ“­ No tienes encargos activos.</td></tr>`;
        }
    }

    // FunciÃ³n auxiliar para ir directo a vender
    function venderEncargo(id) {
        // Redirigimos al carrito o inventario filtrando ese ID (simulado por ahora)
        alert("Para entregar, ve a Inventario y dale a 'Vender' en este producto. El sistema ya sabe que es de este cliente.");
        window.location.href = 'products.html'; 
    }

    function formatMoney(amount) {
        return '$' + amount.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
</script>

</body>
</html>